flowchart LR
    %% Left
    Spectator[["Spectator"]]

    %% Center - Linear Flow
    P331(("3.3.1<br/>Validate & Get<br/>Booking"))
    P332(("3.3.2<br/>Calculate Refund<br/>by Time Policy"))
    P333(("3.3.3<br/>Process<br/>Refund"))
    P334(("3.3.4<br/>Cancel Booking<br/>& Restore Seats"))
    P335(("3.3.5<br/>Update Sales<br/>& Commission"))

    %% Right
    Payment[["Payment<br/>Gateway"]]

    %% Data Stores
    D5[(D5: Bookings)]
    D4[(D4: Shows)]
    D7[(D7: Sales)]
    D8[(D8: Commissions)]

    %% Flows
    Spectator -->|Booking ID| P331
    P331 <-->|Get Booking| D5
    P331 -->|Booking Details| P332
    P332 <-->|Get Show Time| D4
    P332 -->|Refund Amount| P333
    P333 <-->|Process Refund| Payment
    P333 -->|Success| P334
    P334 -->|Mark Cancelled| D5
    P334 -->|Restore Seats| D4
    P334 -->|Complete| P335
    P335 <-->|Update Sale| D7
    P335 -->|Cancel Commission| D8
    P335 -->|Confirmation| Spectator

    classDef external fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    classDef process fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    classDef datastore fill:#ffe0b2,stroke:#e65100,stroke-width:2px

    class Spectator,Payment external
    class P331,P332,P333,P334,P335 process
    class D4,D5,D7,D8 datastore
